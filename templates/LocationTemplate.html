<!DOCTYPE HTML>
<html>
<head>
	<link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/graphics.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/minuteCast.css') }}">
</head>
<body>
	<div class="navigationBar">
		<a href="{{ url_for('home') }}">Home</a>
		<a href="{{ url_for('hourlyPage', locationName=post.locationName) }}">Hourly Forecast</a>
		<a href="#DailyCast">Daily Forecast</a>
		<a href="{{ url_for('timelinePage', locationName=post.locationName) }}">Timeline</a>
		<a href="{{ url_for('loginPage') }}">Login</a>
	</div>
	<div class="navbackground"></div>
	<div class="summaryBox">
		<a id="location"></a>
		<p id="latLong" class="info"></p>
		<p id = "temperature" class="info"></p>
		<p id = "pressure" class="info"></p>
		<p id="summary"></p>
	</div>
	<form id="dataTypePicker">
		<select id="dataTypeSelect"></select>
		<input type="submit" value="submit">
	</form>
	<div class="chart" id="chartDisplay"></div>
	<table class="charts-css bar" id="MinuteCastTemp"></table>
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	<script type="text/javascript">
		google.charts.load('current', {'packages':['corechart']});
		google.charts.setOnLoadCallback(loadDataForChart);
		var temperatureValue = document.getElementById("temperature");
		var pressureValue = document.getElementById("pressure");
		var locationNameDisplay = document.getElementById("location");
		var latLongDisplay = document.getElementById("latLong");
		var summary = document.getElementById("summary");
		var dataTypeSelectBox = document.getElementById("dataTypeSelect");
		var dataTypePicker = document.getElementById('dataTypePicker');
		var jsonRequest;
		var dataSelection = "Temperature";
		var post = {{ post|tojson }};
		for(var i = 0; i < post.dataTypes.length; i++){
			var option = document.createElement("option");
			option.value = post.dataTypes[i];
			option.innerHTML = post.dataTypes[i];
			dataTypeSelectBox.appendChild(option);
		}
		dataTypePicker.addEventListener('submit', function(e) {
    		e.preventDefault();
    		dataSelection = dataTypeSelectBox.options[dataTypeSelectBox.selectedIndex].value;
    		dataTypeChart(dataSelection, jsonRequest);
		})
		function drawChart(dataType, time, typeName, chart) {
        	var data = new google.visualization.DataTable();
          	data.addColumn("date", "Time and date");
          	data.addColumn("number", typeName);
          	for(var i=0; i < dataType.length; i++){
          		dateTime = new Date(Date.UTC(parseInt(time[i].substring(0,4)), parseInt(time[i].substring(5,7))-1, parseInt(time[i].substring(8,10)), parseInt(time[i].substring(12,14))-1, parseInt(time[i].substring(15,17)), parseInt(time[i].substring(18,20))));
          		data.addRow([dateTime, dataType[i]]);
          	}
        	var options = {
          		title: typeName,
          		legend: { position: 'bottom' }
        	};
        	var chart = new google.visualization.LineChart(document.getElementById(chart));
        	chart.draw(data, options);
        }
        function dataTypeChart(dataSelection, jsonRequest){
			if(dataSelection == "Temperature"){
				if(jsonRequest.data.Temperature.data.length > 1){
					drawChart(jsonRequest.data.Temperature.data,jsonRequest.time, "Temperature", "chartDisplay");
				}
			} else if(dataSelection == "Pressure"){
				if(jsonRequest.data.Pressure.data.length > 1){
					drawChart(jsonRequest.data.Pressure.data,jsonRequest.time, "Pressure", "chartDisplay");
				}
			} else if(dataSelection == "Humidity"){
				if(jsonRequest.data.Humidity.data.length > 1){
					drawChart(jsonRequest.data.Humidity.data,jsonRequest.time, "Humidity", "chartDisplay");
				}
			} else if(dataSelection == "Cloud cover"){
				if(jsonRequest.data.CloudCover.data.length > 1){
					drawChart(jsonRequest.data.CloudCover.data,jsonRequest.time, "Cloud cover", "chartDisplay");
				}
			}
		}
        function loadDataForChart(){
			fetch('/'+post.locationName+'/fetchData')
				.then(function (response) {
					return response.json();
				}).then(function (jsonData) {
					jsonRequest = jsonData;
					temperatureValue.innerHTML = "Temperature: "+jsonRequest.data.Temperature.latestValue+" celsius";
					pressureValue.innerHTML = "Pressure: "+jsonRequest.data.Pressure.latestValue+" hPa";
					locationNameDisplay.innerHTML = jsonRequest.location.locationName;
					latLongDisplay.innerHTML = "Latitude: "+jsonRequest.location.latitude+"<br>Longitude: "+jsonRequest.location.longitude;
					if(jsonRequest.data.Pressure.trend == "increase"){
						pressureInfluence = "lower";
					}else{
						pressureInfluence = "higher";
					}
					summary.innerHTML = "Temperature is likely to "+jsonRequest.data.Temperature.trend+" over the next hour. Pressure is likely to "+jsonRequest.data.Pressure.trend+", resulting in a "+pressureInfluence+" chance of cloud cover across the next hour.";
					dataTypeChart(dataSelection, jsonRequest);
				});
		}
		setInterval(loadDataForChart, 60000);
	</script>
</body>
</html>