<!DOCTYPE HTML>
<html>
<head>
	<link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/graphics.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/minuteCast.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/bootstrap.css') }}">
</head>
<body>
	<nav class="navbar navbar-expand-lg bg-dark">
		<div class="container-fluid">
			<a class="navbar-brand" style="color:white;" href="{{ url_for('home') }}">Home</a>
			<ul class="navbar-nav me-auto mb-2 mb-lg-0">
				<li class="nav-item">
					<button class='btn btn-dark' onclick="switchType(60, 'minutecast');">Minutecast</button>
				</li>
			</ul>
			<ul class="navbar-nav me-auto mb-2 mb-lg-0">
				<li class="nav-item">
					<button class='btn btn-dark' onclick="switchType(24, 'H');">Hourly Forecast</button>
				</li>
			</ul>
			<ul class="navbar-nav me-auto mb-2 mb-lg-0">
				<li class="nav-item">
					<button class='btn btn-dark' onclick="switchType(7, 'D');">Daily Forecast</button>
				</li>
			</ul>
			<ul class="navbar-nav me-auto mb-2 mb-lg-0">
				<li class="nav-item">
					<a class="nav-link" style="color:white;" href="{{ url_for('timelinePage', locationName=post.locationName) }}">Timeline</a>
				</li>
			</ul>
			<ul class="navbar-nav me-auto mb-2 mb-lg-0">
				<li class="nav-item">
					<a class="nav-link" style="color:white;" href="{{ url_for('loginPage') }}">Login</a>
				</li>
			</ul>
		</div>
	</nav>
	<div class="card" style="width: 15rem; margin: 10px 25px 25px 25px; float:left;">
		<div class="card-body">
			<h5 class="card-title" id="location"></h5>
			<p id="latLong" class="card-text"></p>
			<p id="temperature" class="card-text"></p>
			<p id="pressure" class="card-text"></p>
			<p id="summary" class="card-text"></p>
		</div>
	</div>
	<div class="card" style="width: 10rem; float:left; margin: 10px 25px 25px 25px; background-color: #242424;">
		<div class="card-body">
			<label style="color:#ffffff">Temperature</label>
			<div style="position: relative; top:30px;" class="gauge" id="temperatureGaugeBackground">
				<div class="inner-gauge" id="temperatureGaugeIndicator">
					<div class="gauge-border">
					</div>
				</div>
			</div>
			<label style="position: relative; top: -40px; left: 40px; color:#ffffff"  id="temperatureCardDisplay"></label>
		</div>
	</div>
	<div class="card" style="width: 10rem; float:left; margin: 10px 25px 25px 25px; background-color: #242424;">
		<div class="card-body">
			<label style="color:#ffffff">Pressure</label>
			<div style="position: relative; top:30px;" class="gauge" id="pressureGaugeBackground">
				<div class="inner-gauge" id="pressureGaugeIndicator">
					<div class="gauge-border">
					</div>
				</div>
			</div>
			<label style="position: relative; top: -40px; left: 30px; color:#ffffff" id="pressureCardDisplay"></label>
		</div>
	</div>
	<div class="card" style="width: 11rem; float:left; margin: 10px 25px 25px 25px; background-color: #242424;">
		<div class="card-body">
			<label id="moonPhaseCard" style="color:#ffffff"></label>
			<div class="moon" id="moon">
				<div class="disc" id="moonPhaseIndicator"></div>
			</div>
		</div>
	</div>
	<form style="position:relative; top:-120px; right: 25px; float:left;" id="sampleTypePicker">
		<div style="position:relative; right:30px; float:left;" class="input-group mb-3">
			<input class="btn btn-secondary" type="submit" value="submit">
			<select id="sampleTypeSelect"></select>
		</div>
	</form>
	<div style="float:left; right:290px; top:55px;" class="chart" id="chartDisplay"></div>
	<div class="warning">
		<a id="warning"></a>
	</div>
	<div style="position: relative; top:50px; left: 10px; width:1850px; margin:10px 10px 10px 10px; overflow:scroll;">
		<table id="table" class="table table-striped-columns">
		</table>
	</div>
	<table class="charts-css bar" id="MinuteCastTemp"></table>
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	<script type="text/javascript">
		google.charts.load('current', {'packages':['corechart']});
		google.charts.setOnLoadCallback(loadDataForChart);
		var temperatureValue = document.getElementById('temperature');
		var pressureValue = document.getElementById('pressure');
		var locationNameDisplay = document.getElementById('location');
		var latLongDisplay = document.getElementById('latLong');
		var summary = document.getElementById('summary');
		var sampleTypeSelectBox = document.getElementById('sampleTypeSelect');
		var sampleTypePicker = document.getElementById('sampleTypePicker');
		var table = document.getElementById('table')
		var warning = document.getElementById('warning');
		var jsonRequest;
		var dataSelection = 'TEMPERATURE';
		var post = {{ post|tojson }};
		var link = '/fetchData?locationName='+post.locationName;
		document.getElementById('moonPhaseCard').innerHTML = "Moon phase: "+parseInt(post.moonPhase)+"%";
		if(post.moonPhase < 50){
			document.getElementById('moonPhaseIndicator').style = "background-color:#242424; transform:rotateY("+parseInt((post.moonPhase/100)*180)+"deg);";
		} else{
			document.getElementById('moonPhaseIndicator').style = "background-color:#ffffff; transform:rotateY("+parseInt((post.moonPhase/100)*180)+"deg);";
		}
		if(post.stormWarning != 'None'){
			warning.innerHTML = "Extreme weather warning notice from "+post.stormWarning;
			document.body.style.backgroundImage = "url({{url_for('static',filename='styles/backgrounds/Storm.jpg')}})";
		}
		for(var i = 0; i < post.sampleTypes.length; i++){
			var option = document.createElement("option");
			option.value = post.sampleTypes[i];
			option.innerHTML = post.sampleTypes[i];
			sampleTypeSelectBox.appendChild(option);
		}
		sampleTypePicker.addEventListener('submit', function(e) {
    		e.preventDefault();
    		dataSelection = sampleTypeSelectBox.options[sampleTypeSelectBox.selectedIndex].value;
    		sampleTypeChart(dataSelection, jsonRequest);
		})
		function displayLatest(sampleType, value){
			document.getElementById(sampleType+"CardDisplay").innerHTML = value;
		}
		function drawChart(sampleType, time, typeName, chart) {
        	var data = new google.visualization.DataTable();
          	data.addColumn("date", "Time and date");
          	data.addColumn("number", typeName);
          	for(var i=0; i < sampleType.length; i++){
          		dateTime = new Date(Date.UTC(parseInt(time[i].substring(0,4)), parseInt(time[i].substring(5,7))-1, parseInt(time[i].substring(8,10)), parseInt(time[i].substring(12,14)), parseInt(time[i].substring(15,17)), parseInt(time[i].substring(18,20))));
          		data.addRow([dateTime, sampleType[i]]);
          	}
        	var options = {
          		title: typeName,
          		legend: { position: 'bottom' }
        	};
        	var chart = new google.visualization.LineChart(document.getElementById(chart));
        	chart.draw(data, options);
        }
        function sampleTypeChart(dataSelection, jsonRequest){
        	console.log(dataSelection);
			if(jsonRequest.data[dataSelection].data.length > 1){
				drawChart(jsonRequest.data[dataSelection].data,jsonRequest.data[dataSelection].time, dataSelection, "chartDisplay");
			}
		}
		function makeTable(jsonRequest){
			var tableInsert = "";
			tableInsert += "<tr><th>Time</th>";
			for(var i = 0; i < jsonRequest.data[post.sampleTypes[0]].time.length; i++){
				tableInsert += '<td>'+jsonRequest.data[post.sampleTypes[0]].time[i]+'</td>'
			}
			tableInsert += "</tr>";
			for(var i = 0; i < post.sampleTypes.length; i++){
				if(jsonRequest.data[post.sampleTypes[i]].data.length > 1){
					tableInsert += "<tr><th>"+post.sampleTypes[i]+"</th>";
					for(var j = 0; j < jsonRequest.data[post.sampleTypes[i]].data.length; j++){
						tableInsert += '<td>'+jsonRequest.data[post.sampleTypes[i]].data[j]+'</td>'
					}
					tableInsert += "</tr>";
				}
			}
			table.innerHTML = tableInsert;
		}
		function toggleGauge(gauge, value, min, max){
			var ratio = (value-min)/(max-min);
			var rotation = ratio*180;
			gauge.style = "transform:rotate("+rotation+"deg); ";
		}
        function loadDataForChart(link){
			fetch(link)
				.then(function (response) {
					return response.json();
				}).then(function (jsonData) {
					jsonRequest = jsonData;
					temperatureValue.innerHTML = "Temperature: "+jsonRequest.data.TEMPERATURE.latestValue+" celsius";
					pressureValue.innerHTML = "Pressure: "+jsonRequest.data.PRESSURE.latestValue+" hPa";
					displayLatest("temperature", jsonRequest.data.TEMPERATURE.latestValue);
					displayLatest("pressure", jsonRequest.data.PRESSURE.latestValue);
					locationNameDisplay.innerHTML = jsonRequest.location.locationName;
					latLongDisplay.innerHTML = "Latitude: "+jsonRequest.location.latitude+"<br>Longitude: "+jsonRequest.location.longitude;
					if(jsonRequest.data.PRESSURE.trend == "increase"){
						pressureInfluence = "lower";
					}else{
						pressureInfluence = "higher";
					}
					summary.innerHTML = "Temperature is likely to "+jsonRequest.data.TEMPERATURE.trend+" over the next hour. Pressure is likely to "+jsonRequest.data.PRESSURE.trend+", resulting in a "+pressureInfluence+" chance of cloud cover across the next hour.";
						if(jsonRequest.data.TEMPERATURE.latestValue >= 30){
						document.body.style.backgroundImage = "url({{url_for('static',filename='styles/backgrounds/Dry.jpg')}})";
					} else if(jsonRequest.data.TEMPERATURE.latestValues >= 20 & jsonRequest.data.TEMPERATURE.latestValues <= 30){
						document.body.style.backgroundImage = "url({{url_for('static',filename='styles/backgrounds/Sunset2.jpg')}})";
					} else if(jsonRequest.data.TEMPERATURE.latestValues >= 10 & jsonRequest.data.TEMPERATURE.latestValues <= 20){
						document.body.style.backgroundImage = "url({{url_for('static',filename='styles/backgrounds/spring.jpg')}})";
					} else{
						document.body.style.backgroundImage = "url({{url_for('static',filename='styles/backgrounds/winter.jpg')}})";
					}
					if(post.stormWarning != 'None'){
						warning.innerHTML = "Extreme weather warning notice from "+post.stormWarning;
						document.body.style.backgroundImage = "url({{url_for('static',filename='styles/Storm.jpg')}})";
					}
					toggleGauge(document.getElementById("temperatureGaugeIndicator"), jsonRequest.data.TEMPERATURE.latestValue, -40, 100)
					toggleGauge( document.getElementById("pressureGaugeIndicator"), jsonRequest.data.PRESSURE.latestValue, 950, 1050)
					console.log(jsonRequest)
					makeTable(jsonRequest);
					sampleTypeChart(dataSelection, jsonRequest);
				});
		}
		function switchType(period, periodType){
			if(periodType == 'minutecast'){
				link = '/fetchData?locationName='+post.locationName
				loadDataForChart(link);
			} else{
				link = '/fetchMachineLearningPredictions?locationName='+post.locationName+'&period='+period+'&periodType='+periodType;
				loadDataForChart(link);
			}
		}
		setInterval(loadDataForChart(link), 60000);
	</script>
</body>
</html>